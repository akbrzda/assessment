# Расширение модуля аттестаций: теория перед вопросами

План работ по добавлению теоретических материалов (текст/видео) к каждой аттестации и блокировке перехода к вопросам до изучения обязательной теории.

## Completed Tasks

- [x] Проведён аудит всех сервисов (backend, admin-frontend, miniapp frontend, Telegram-бот) и текущей реализации модуля аттестаций.

## In Progress Tasks

- [ ] Уточнить правила: требуется ли повторное изучение теории перед каждой новой попыткой или достаточно один раз на аттестацию.
- [ ] Определить способ хранения видео (локально в `uploads`, в existing CDN/S3 либо через ссылки на внешние платформы) и лимиты по размеру.

## Future Tasks

- [ ] Добавить в БД хранение теоретических блоков и пользовательского прогресса, подготовить миграции/сидеры.
- [ ] Обновить backend-модели, валидацию и API (админские и пользовательские эндпоинты + новая точка для фиксации прогресса).
- [ ] Расширить админ-панель (мастер создания/редактирования аттестаций, просмотр теории, загрузка видео).
- [ ] Доработать мини-приложение (экраны теории, видеоплеер, отслеживание скролла/просмотра, блокировка кнопок начала теста).
- [ ] Настроить аналитику и уведомления (логирование чтения, отчёты, при необходимости – напоминания через бот).
- [ ] Написать автотесты/ручные чек-листы, обновить данные для локальной разработки.

## Implementation Plan

### 1. Архитектура и текущее состояние

- **Backend (`backend/`)** – Node.js + Express + MySQL. Модули: `controllers`, `models`, `services`, `middleware`. Аттестации обслуживаются `assessmentRoutes` → `assessmentController` → `assessmentModel`, таблицы создаются миграцией `003_create_assessments.sql`.
- **Admin-frontend (`admin-frontend/`)** – Vue 3 (Vite, Pinia, axios). Аттестации управляются через `AssessmentWizard`, `AssessmentsView`, API-клиент `src/api/assessments.js`, авторизация по JWT.
- **Мини-приложение (`frontend/`)** – отдельный Vue 3 проект, интеграция с Telegram WebApp (initData в заголовках). Пользовательские сценарии находятся в `AssessmentsView.vue`, `AssessmentProcessView.vue`, данные тянутся через `frontend/src/services/apiClient.js`.
- **Telegram-бот (`bot/`)** – Telegraf, отвечает за выдачу ссылки на MiniApp; бизнес-логика аттестаций здесь не реализована, но важно учитывать возможные уведомления.
- **Текущая логика** – админ задаёт вопросы/варианты, назначает пользователей/филиалы, пользователь сразу начинает попытку (после проверки оконных дат и лимитов). Теории нет, прогресс не отслеживается.

### 2. Модель данных и миграции

1. **Новые таблицы**:
   - `assessment_theory_blocks`: `id`, `assessment_id`, `order_index`, `type` (`text`/`video`), `title`, `content_text` (LONGTEXT для rich-text), `video_url`, `video_duration_seconds`, `min_read_seconds`, `is_required`, `preview_url`, timestamps.
   - `assessment_theory_assets` (опционально) для загрузок (хранит путь к файлу, mime, размер) – если решим поддержать собственные загрузки видео/превью.
   - `assessment_theory_progress`: `id`, `assessment_id`, `user_id`, `block_id`, `progress_percent`, `watched_seconds`, `scroll_percent`, `is_completed`, `completed_at`, `last_interaction_at`, `attempt_id` (nullable, если привязываем к конкретной попытке).
2. **Изменения существующих таблиц**:
   - В `assessments` добавить флаги `theory_required TINYINT(1)` и, при необходимости, `theory_version` для инвалидации старого прогресса.
3. **Индексы** – `(assessment_id, order_index)` для блоков, `(assessment_id, user_id, block_id)` для прогресса.
4. **Миграции** – создать новую миграцию `019_assessment_theory.sql`, продумать обратные операции. Для существующих аттестаций `theory_required = 0`, никаких блоков.

### 3. Backend

1. **Конфигурация/модели**:
   - Расширить `assessmentModel` методами `createTheoryBlocks`, `updateTheoryBlocks`, `listTheoryBlocks`, `upsertTheoryProgress`, `getTheoryProgress`.
   - В `createAssessment/updateAssessment` принимать `theoryBlocks` (массива объектов). Логику обернуть в ту же транзакцию, что и вопросы/назначения.
   - Добавить helper для маппинга теории в `mapAssessmentRow`.
2. **Валидация (`assessmentController`)**:
   - Расширить `baseSchema`: `theoryBlocks` – массив объектов `{ type, title, contentText, videoUrl, videoDurationSeconds, minReadSeconds, isRequired }`. Проверять, что есть либо текст, либо видео URL, что длительность >0, порядок уникален.
3. **Эндпоинты**:
   - `GET /assessments/user/:id` – возвращает `theoryBlocks` c прогрессом пользователя, поле `theoryRequired`.
   - `POST /assessments/:id/theory/:blockId/progress` (новый) – требует роль employee/manager, принимает `progressPercent`, `watchedSeconds`, `isCompleted`, `attemptId?`. Сервер сам сверяет длительность/минимальное время, округляет значения.
   - `POST /assessments/:id/attempts` – перед созданием попытки проверяет: если `theoryRequired=1`, все обязательные блоки завершены (по прогрессу, либо `completed_at` >= `theory_version`). При нарушении возвращает `409 Conflict` с ошибкой.
   - Админские `GET /admin/assessments/:id` и `list` – включают информацию о теории для просмотра/редакта.
4. **Сервисы/аудит** – если ведётся аудит (`auditService`), логировать создание/обновление блоков, завершение теории.
5. **Файлы/загрузка**:
   - При поддержке загрузки видео использовать `multer` (подобно `badgesRoutes`), хранить в `uploads/theory`. Контроллер выдаёт URL, админ сохраняет в блоке `videoUrl`.
6. **Scheduler/analytics** – при необходимости добавить методы для отчётов (например, `% пользователей прошли теорию, но не начали попытку`).

### 4. Admin-frontend

1. **Состояние и API**:
   - Обновить `src/api/assessments.js` для передачи `theoryBlocks` при создании/редактировании.
   - В Pinia-сторе, если используется кэш, добавить поддержку новых полей.
2. **AssessmentWizard**:
   - Добавить новый шаг (например, после базовой информации) с настройкой теории:
     - Список блоков с drag&drop порядком.
     - Редактор текста (минимум textarea + markdown preview, позже можно интегрировать готовый WYSIWYG).
     - Поля для видео: загрузка файла или ввод URL + длительность (можно пытаться читать metadata через `<video>`/File API).
     - Флаг «обязательный блок».
   - Валидации на фронте: минимум один блок, если теория обязательна; видео обязательные поля.
3. **Просмотр аттестации**:
   - В `AssessmentDetailsView` показать список блоков, статистику прохождения (если backend вернёт).
4. **UX**:
   - Предусмотреть превью/плеер прямо в админке.
   - При загрузке больших файлов показывать прогресс, использовать существующий axios-инстанс с `onUploadProgress`.

### 5. MiniApp frontend

1. **API-слой (`apiClient`)** – добавить методы `recordTheoryProgress(assessmentId, blockId, payload)` и поля `theoryBlocks` в существующие мапперы.
2. **Маршруты**:
   - Разделить прохождение на два экрана: `AssessmentTheoryView` (новый) + обновлённый `AssessmentProcessView`.
   - Маршрут `/assessments/:id/theory` – показывает список блоков, прогресс, кнопка «Перейти к вопросам» активна только после завершения всех обязательных блоков.
3. **UI-компоненты**:
   - `TheoryBlockViewer` – рендер текста с поддержкой базовой разметки, показывать индикатор прочтения (напр., прогресс-бар по скроллу, `IntersectionObserver` фиксирует достижение конца).
   - `VideoPlayer` – основанный на `<video>` или лёгкой библиотеке; отслеживает смотренное время (`timeupdate`), запрещает перемотку вперёд, фиксирует факт полного просмотра при `currentTime >= duration - threshold`.
4. **Логика прогресса**:
   - Сохранять локально (Pinia/IndexedDB) и периодически отправлять на backend (ddebounce).
   - «Я ознакомлен» кнопка для текстовых блоков (доступна после 100% скролла *и* минимального времени чтения).
5. **Блокировка попытки**:
   - На экране списка аттестаций показывать бейдж «Есть теория», а кнопку «Начать» заменять на «Перейти к теории» если обязательные блоки не завершены (на основе `assessment.userTheoryStatus` из API).
   - При прямом переходе на `/assessments/:id/process` дополнительно проверять `assessment.theoryRequired && !assessment.theoryCompleted`, отправлять пользователя на `/theory`.
6. **Поведение при нескольких попытках**:
   - Если теория обязательна перед каждой попыткой – сбрасывать флаг на бэке (через `attempt_id`). Если достаточно один раз – показывать зелёную отметку и позволять начинать новые попытки без повторного просмотра.

### 6. Геймификация, отчёты, бот

- **Геймификация** – решить, нужно ли начислять баллы за прохождение теории. Если да, задействовать `gamificationService` при завершении всех блоков.
- **Отчёты** – обновить `admin-frontend/src/views/ReportsView.vue`/аналитические API, добавив метрики: конверсия «изучил теорию → начал попытку», среднее время на блоке, популярность видео.
- **Бот** – пока изменений нет; при необходимости добавить уведомления о новой теории или напоминания (использовать `assessment_theory_progress` для определения «не изучил»).

### 7. Тестирование и миграция

1. **Миграции** – прогнать локально/стейдже, проверить откат.
2. **Unit/e2e**:
   - Backend: тесты на `assessmentController.create/update`, `POST /attempts` (ошибки без теории), `POST /theory/progress`.
   - Frontend: компонентные тесты `TheoryBlockViewer`, интеграционные сценарии (можно Cypress) – пользователь читает теорию, кнопка «Начать» активируется.
3. **Данные** – подготовить seed-скрипт с примерной теорией, видео-заглушками.
4. **Regression** – убедиться, что существующие аттестации без теории работают как раньше (флаг `theoryRequired=0`).

## Relevant Files

- `backend/src/models/assessmentModel.js` – придётся расширить CRUD аттестаций, добавить работу с таблицами теории и прогресса.
- `backend/src/controllers/assessmentController.js` – новая валидация входных данных, эндпоинты для прогресса и проверки перед созданием попыток.
- `backend/database/migrations/003_create_assessments.sql` + новая миграция `019_assessment_theory.sql` – описание схемы данных.
- `admin-frontend/src/components/AssessmentWizard.vue` – добавление шага настройки теории и UX по управлению блоками.
- `admin-frontend/src/views/AssessmentsView.vue` и `AssessmentDetailsView.vue` – вывод информации о наличии теории и статистике.
- `frontend/src/services/apiClient.js` – новые запросы (прогресс, получение теории) и возврат структурированных данных.
- `frontend/src/views/AssessmentsView.vue` / `AssessmentProcessView.vue` (и новый `AssessmentTheoryView.vue`) – пользовательские сценарии изучения теории и старта теста.
- `bot/src/index.js` – изменений не требуется, но важно учесть при возможных уведомлениях (использует `MINI_APP_URL`).

## Дополнительные рекомендации

- Хранить rich-text теории в формате Markdown/HTML, валидировать на бэке и экранировать на фронте, чтобы избежать XSS.
- Для видео предусмотреть фоновую обработку (сжатие, превью) и ограничение по размеру. Если объёмы большие, выгоднее сразу интегрировать облачное хранилище.
- Минимизировать дублирование кода: переиспользовать существующие компоненты загрузки (см. `badges`), таймеры из `AssessmentProcessView`, сервисы логирования.
- Валидацию прогресса делать на сервере: клиент может отправлять только фактические метрики, решение о завершении блока принимает бэк на основании настроек (`min_read_seconds`, `video_duration_seconds`).
- Подготовить fallback для оффлайн-сценариев (кешировать теорию в localStorage и синхронизировать прогресс при восстановлении сети).
