# Исправления в аттестациях

Проблемы:
- при создании аттестации с включенной теорией теоретический блок не сохраняется
- предупреждение Vue о недостающем isSaving в AssessmentProcessView
- переход на пакетное сохранение ответов и localStorage для попыток

## Completed Tasks

- [x] Изучить текущую логику создания аттестации и сохранения теории
- [x] Исправить получение ID созданной аттестации для сохранения теории
- [x] Определить источник предупреждения Vue по isSaving
- [x] Исправить экспорт isSaving в шаблон AssessmentProcessView
- [x] Исправить выбор ответов для вопросов с множественным выбором
- [x] Добавить batch endpoint для сохранения ответов
- [x] Перенести сохранение ответов в localStorage и отправку пачкой при завершении
- [x] Обновить клиентский API для batch отправки ответов
- [x] Исправить получение attempt.id при старте попытки
- [x] Исключить устаревшие назначения по должности/филиалу из выдачи пользователю
- [x] Разделить прямые назначения и авто-назначения по должности/филиалу
- [x] Добавить проверку доступа к теории аттестации в MiniApp
- [x] Пересчитывать авто-назначения при смене должности/филиала без сброса прогресса
- [x] Учесть пересечение филиал+должность в выдаче аттестаций и доступе к теории
- [x] Привести список назначенных пользователей в админке к актуальным правилам назначения
- [x] Оставлять прогресс при переназначении по должности/филиалу
- [x] Инвалидировать кеш админских аттестаций при смене пользователя
- [x] Обновить список типов вопросов в админке и совпадение с формулировками банка
- [x] Добавить парное сопоставление (левый/правый столбец) в API, модели и миниапп

## In Progress Tasks

- [ ] Проверить поведение создания аттестации с теорией в UI
- [ ] Проверить, что предупреждение Vue по isSaving исчезло
- [ ] Проверить выбор нескольких вариантов в аттестации
- [ ] Проверить сохранение ответов и завершение аттестации с batch отправкой
- [ ] Проверить запись localStorage после старта попытки
- [ ] Проверить, что аттестации по старой должности скрываются после смены
- [ ] Проверить показ аттестации при прямом назначении вне должности/филиала
- [ ] Проверить запрет доступа к теории при отсутствии прав
- [ ] Проверить сохранение прогресса при переназначении
- [ ] Проверить корректность фильтрации при комбинации филиал+должность
- [ ] Проверить, что в админке не показываются неподходящие пользователи
- [ ] Проверить обновление данных в админке без ожидания кеша
- [ ] Проверить создание/редактирование вопросов с типом "сопоставление" в банке и аттестациях
- [ ] Проверить прохождение вопросов типа "сопоставление" в миниаппе

## Future Tasks

## Implementation Plan

Использовать localStorage для накопления ответов в процессе и отправлять их пачкой при завершении попытки через новый endpoint.
Для "сопоставления" хранить пары (левый текст + правый текст) через `match_text` и передавать ответы как пары `leftOptionId`/`rightOptionId`.

### Relevant Files

- admin-frontend/src/components/AssessmentWizard.vue - мастер создания аттестации и сохранение теории ✅
- backend/src/controllers/adminAssessmentController.js - ответ API при создании аттестации
- backend/src/controllers/assessmentController.js - batch endpoint для ответов ✅
- backend/src/models/assessmentModel.js - пакетное сохранение ответов ✅
- backend/src/routes/assessmentRoutes.js - маршрут batch отправки ✅
- backend/database/migrations/002_add_is_direct_to_assessment_user_assignments.sql - признак прямого назначения ✅
- frontend/src/views/AssessmentProcessView.vue - прохождение аттестации и localStorage ✅
- frontend/src/services/apiClient.js - batch API клиент ✅
- admin-frontend/src/components/QuestionForm.vue - создание/редактирование вопросов ✅
- admin-frontend/src/components/AssessmentWizard.vue - мастер создания аттестации ✅
- admin-frontend/src/components/AssessmentEditForm.vue - редактирование аттестации ✅
- admin-frontend/src/views/QuestionsView.vue - список вопросов и фильтры ✅
- admin-frontend/src/components/QuestionView.vue - просмотр вопроса ✅
- frontend/src/views/AssessmentProcessView.vue - прохождение аттестации ✅
- backend/src/controllers/adminQuestionBankController.js - валидация банка вопросов ✅
- backend/src/controllers/assessmentController.js - валидация вопросов аттестации ✅
- backend/src/models/assessmentModel.js - сохранение и проверка ответов ✅
- backend/database/migrations/003_add_matching_question_type.sql - миграция типа "сопоставление" ✅
- backend/database/migrations/004_add_match_text_to_question_options.sql - пары для сопоставления ✅
- TASKS.md - трекинг задач по исправлению ✅
