
# Описание фичи: Обязательная теория перед аттестацией

## Цель фичи
Фича предназначена для того, чтобы пользователь **обязательно ознакомился с теоретическими материалами** перед прохождением аттестации. Теория может включать текстовые и видео-блоки, а также дополнительные материалы.

Фича решает проблему формального прохождения тестов без изучения контекста и повышает качество аттестации.

---

## Общий принцип работы

1. К аттестации может быть привязана теория.
2. Теория состоит из блоков:
   - обязательных (required)
   - дополнительных (optional)
3. Пока обязательная теория не пройдена, пользователь **не может начать тест**.
4. После прохождения теории пользователь получает доступ к аттестации.
5. При обновлении теории доступ может быть сброшен.

---

## Структура теории

### Обязательные блоки
- отображаются в основном потоке страницы
- должны быть пройдены для допуска к тесту
- бывают:
  - текстовые (completion = скролл до конца)
  - видео (completion = достижение конца видео, если возможно отследить)

### Дополнительные блоки
- отображаются в секции «Дополнительные материалы»
- оформлены в виде аккордеона
- не влияют на доступ к тесту
- доступны всегда

---

## Логика прохождения теории

- Все блоки отображаются **на одной странице**
- Пользователь может изучать блоки **в любом порядке**
- Прогресс отслеживается локально:
  - в памяти приложения
  - в sessionStorage (на время сессии браузера)
- Если пользователь закрыл вкладку или браузер — прогресс сбрасывается

---

## Completion теории

Теория считается пройденной, если:
- пользователь в рамках одной сессии
- прошёл **все обязательные блоки**
- после чего отправляется событие завершения на сервер

Сервер сохраняет факт прохождения теории:
- пользователь
- аттестация
- версия теории

---

## Версионность теории

### Обновление теории
В админке доступны две кнопки:
- «Опубликовать текущую версию»
- «Опубликовать новую версию теории»

### Автоматическое обновление версии
Если админ:
- добавляет новый обязательный блок  
→ версия теории **автоматически увеличивается**, даже если выбрана публикация текущей версии.

### Поведение при обновлении версии
- весь прогресс пользователей сбрасывается
- теория снова становится обязательной

---

## Поведение при обновлении во время прохождения

Если версия теории обновилась, пока пользователь изучает материал:
- показывается баннер «Теория обновлена»
- кнопка перехода к тесту блокируется
- пользователь должен пройти новую версию

---

## Работа с видео

- Админ может вставить **любую ссылку** (VK, RuTube, YouTube и т.д.)
- Запрет перемотки вперёд **не гарантируется**
- Completion:
  - по событию завершения видео, если доступно
  - либо условно, если iframe не отдаёт события

---

## UX-блокировки

- Кнопка «Начать тест»:
  - заблокирована, если теория не пройдена
  - сопровождается текстом-пояснением
- Никаких модалок и редиректов

---

## Edge-cases

### Несколько вкладок
- вкладки не синхронизируются
- backend — источник истины
- состояние обновляется при действии пользователя

### Обновление страницы
- прогресс сохраняется в рамках sessionStorage
- при новой сессии — сбрасывается

### Плохой интернет / видео не грузится
- показывается ошибка
- completion невозможен
- обходных путей нет

### Изменения optional-блоков
- не влияют на обязательность
- доступ к тесту сохраняется
