# Масштабирование на несколько брендов и форматов

## 1. Текущее устройство

1. **Единая база данных**:
   - `branches`, `positions`, `users`, `roles`, `assessments`, `question_bank` и пр. хранятся в общих таблицах без признака бренда.
   - Названия филиалов (`branches.name`) и должностей (`positions.name`) должны быть уникальными глобально (`UNIQUE`), что затрудняет ведение одноимённых сущностей для разных брендов.
2. **Приглашения и роли**:
   - Инвайт (`invitations`) связывается только с `branch_id` и `role_id`, нет возможности ограничить доступ брендом.
   - Менеджер видит всех пользователей филиала (или нескольких), без фильтра по бренду.
3. **Геймификация и лидерборды**:
   - Очки, бейджи и логи хранятся в общих таблицах (`gamification_events`, `user_badges`) и агрегируются без учёта бренда.
   - Лидерборды и аналитика (`admin-frontend/src/views/ReportsView.vue`, `frontend/src/views/LeaderboardView.vue`) строятся по всей базе.
4. **Настройки и операции**:
   - Системные настройки (`system_settings`) и конфигурация геймификации одинаковы для всех.
   - Логи действий (`action_logs`) и Telegram‑уведомления не содержат признака бренда.

## 2. Возможные сценарии масштабирования

### 2.1 Одинаковые филиалы и должности

Если несколько брендов используют идентичные справочники филиалов и должностей, можно:
1. Завести их как разные **ветки** (`branches`), например `BrandA — Москва`, `BrandB — Москва`.
2. Создать отдельные **должности** с префиксами (например, `BrandA — Бариста`), чтобы избежать коллизий.
3. Использовать только части системы, не предполагающие смешение данных (например, аналитика по филиалам/ролям).  

**Ограничения**:
- уникальность названий требует строгих соглашений;
- менеджеры/суперадмины должны следить, чтобы не назначить сотрудников «чужого» бренда;
- лидерборды и отчёты будут общими, т.е. придётся фильтровать вручную (например, по префиксу в названии).

### 2.2 Разные структуры (уникальные должности/процессы)

При кардинально разных форматах брендов возникают проблемы:
1. **Общие справочники** — нужно хранить разные наборы вопросов, уровней, настроек. Сейчас они глобальны.
2. **Права доступа** — менеджер бренда может увидеть все филиалы, если получить `superadmin`. Для разграничения нужен признак в каждой таблице.
3. **Геймификация** — настраивается единообразно; нельзя для бренда B отключить бонусы, оставив их для бренда A.
4. **Отчёты и лидерборды** — смешиваются мгновенно, нет фильтра по бренду.

## 3. Рекомендации по внедрению мультибрендовости

1. **Добавить признак бренда (`brand_id`)** в ключевые таблицы:
   - `branches`, `positions`, `users`, `assessments`, `question_bank`, `gamification_events`, `action_logs`, `system_settings`.
   - Создать таблицу `brands` с параметрами (название, конфигурация, настройки).
2. **Изменить маршруты и сервисы**:
   - Все запросы должны фильтровать данные по `brand_id`. Относится к админ‑панели, API MiniApp и планировщику.
   - Для авторизации хранить `brand_id` в payload токена или извлекать по пользователю.
3. **Справочники**:
   - отказаться от уникальности имени на уровне таблиц; использовать уникальный индекс `(brand_id, name)` или `name` в рамках бренда.
   - обеспечить изоляцию вопросного банка, шаблонов аттестаций и отчётов.
4. **Геймификация/настройки**:
   - хранить правила и уровни на брендовом уровне (либо дать возможность отключать геймификацию для бренда).
   - при расчёте стриков и очков фильтровать данные по бренду.
5. **Логирование / Telegram**:
   - формировать сообщения с указанием бренда;
   - возможно использовать разные чаты для разных брендов.
6. **Интерфейсы**:
   - добавить селекторы бренда в админке и MiniApp (если сотрудник работает в нескольких брендах).
   - ограничить доступ менеджеров к «своим» брендам через middleware (`verifyAdminRole` + проверка бренда).

## 4. Потенциальные риски

- **Миграция данных** — для существующей базы потребуется проставить `brand_id` всем сущностям.
- **Планировщик** — текущий scheduler не учитывает бренд; при разделении нужно запускать задачи отдельно для каждого бренда или фильтровать данные.
- **Telegram‑боты** — один бот на несколько брендов может быть недостаточно гибким (разные тексты, разные группы).
- **Производительность** — при добавлении фильтра `brand_id` индексы должны быть пересмотрены (`INDEX (brand_id, ...)` на таблицах с отчётами).

## 5. Итог

Система сейчас рассчитана на один бренд с множеством филиалов. Перенос на много брендов возможен при строгой дисциплине именования, но без структурных изменений это решение хрупко: лидерборды, отчёты, настройки и уведомления будут общими. Для полноценной мультибрендовости необходимо ввести `brand_id` во все доменные таблицы, переработать фильтрацию в API, разделить справочники и конфигурацию, а также продумать отдельные каналы уведомлений для каждой сети.
